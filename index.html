<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add & Pop! Homework</title>

  <!-- Screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- CSV Parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    body {
      font-family: "Comic Sans MS", cursive;
      background: linear-gradient(135deg, #fdeff9, #ecf0ff);
      text-align: center;
      padding: 12px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #333;
    }

    h1 { font-size: 34px; margin-bottom: 6px; }

    .card {
      background: white;
      border-radius: 18px;
      padding: 16px;
      margin: 12px auto;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      max-width: 380px;
    }

    .fruits {
      font-size: 48px;
      display: inline-block;
      animation: drop 0.5s ease-out;
    }

    @keyframes drop {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .correct-anim { animation: bounce 0.6s ease; }
    @keyframes bounce {
      0% { transform: scale(1); }
      30% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .wrong-anim { animation: shake 0.4s ease; }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-6px); }
      100% { transform: translateX(0); }
    }

    button {
      border: none;
      cursor: pointer;
    }

    .answer-btn {
      font-size: 32px;
      padding: 12px 24px;
      margin: 8px;
      border-radius: 16px;
      border: 3px solid #555;
      background: white;
      color: #222;
      min-width: 80px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .answer-btn:disabled { opacity: 0.4; }

    .answer-btn:active { transform: scale(0.94); }

    .whatsapp-btn { background: #25D366; color:white; font-size: 26px; padding:14px 22px; border-radius:14px; }
    .replay-btn { background: #ffb300; color:white; font-size:26px; padding:14px 22px; border-radius:14px; }
    .submit-btn { background: #007bff; color:white; font-size:26px; padding:14px 22px; border-radius:14px; }

    input {
      font-size: 22px;
      padding: 10px;
      border-radius: 12px;
      border: 2px solid #aaa;
      text-align: center;
      width: 85%;
    }

    #result {
      font-size: 32px;
      margin-top: 6px;
      min-height: 40px;
    }

    .progress { font-size: 20px; margin-bottom: 10px; color: #555; }

    .leader { font-size: 22px; margin: 6px; }

    .teacher {
      font-size: 60px;
      margin-bottom: 6px;
      animation: bounce 1.5s infinite alternate;
    }

    .confetti {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      animation: confetti-fall 1s ease-out forwards;
      font-size: 38px;
    }
    @keyframes confetti-fall {
      from { transform: translateY(-120px); opacity: 1; }
      to { transform: translateY(300px); opacity: 0; }
    }

    footer {
      margin-top: auto;
      padding: 8px;
      font-size: 16px;
      color: #666;
      opacity: 0.95;
    }
  </style>
</head>

<body>

<h1>üçé Add & Pop üçå</h1>

<div id="nameScreen" class="card">
  <p>Type your name</p>
  <input id="nameInput" />
  <br><br>
  <button onclick="startGame()" class="submit-btn">Start</button>
</div>

<div id="gameScreen" class="card" style="display:none;">
  <div class="progress"><span id="qno"></span> / 15</div>
  <div id="question"></div>
  <div id="options"></div>
  <div id="result"></div>
</div>

<div id="endScreen" class="card" style="display:none;">
  <div class="teacher">üë©‚Äçüè´</div>
  <h2 id="endCelebration"></h2>
  <p id="finalScore"></p>

  <h3>üèÜ Leaderboard</h3>
  <div id="leaderboard">Loading...</div>

  <br>
  <button onclick="shareResult()" class="whatsapp-btn">üü¢ WhatsApp</button>
  <button onclick="location.reload()" class="replay-btn">üîÑ Replay</button>
</div>

<footer>An MPPS Pedduru Initiative</footer>

<script>
  let name = "";
  let score = 0;
  let streak = 0;
  let questionCount = 0;
  let correct;
  const TOTAL = 15;
  let answered = false;
  const fruits = ["üçé","üçå","üçá","üçì"];

  const ctx = new (window.AudioContext||window.webkitAudioContext)();

  function sound(f,d){
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.frequency.value=f;
    o.connect(g); 
    g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);
    o.stop(ctx.currentTime+d);
  }

  function confettiBurst(symbol){
    const c=document.createElement("div");
    c.className="confetti";
    c.textContent=symbol;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),900);
  }

  function startGame(){
    name=document.getElementById("nameInput").value||"Friend";
    document.getElementById("nameScreen").style.display="none";
    document.getElementById("gameScreen").style.display="block";
    nextQ();
  }

  function nextQ(){
    answered=false;
    if(questionCount===TOTAL){ endGame(); return; }

    questionCount++;
    document.getElementById("qno").innerHTML=questionCount;
    document.getElementById("result").innerHTML="";

    const a=Math.floor(Math.random()*5)+1;
    const b=Math.floor(Math.random()*5)+1;
    correct=a+b;

    const f1=fruits[Math.floor(Math.random()*fruits.length)];
    const f2=fruits[Math.floor(Math.random()*fruits.length)];

    document.getElementById("question").innerHTML=
      `<div class="fruits">${f1.repeat(a)}</div><br>
       <div style="font-size:36px;">+</div><br>
       <div class="fruits">${f2.repeat(b)}</div>`;

    const ops=[correct,correct+1,correct-1].filter(n=>n>0).sort(()=>Math.random()-0.5);

    const optionsDiv=document.getElementById("options");
    optionsDiv.innerHTML="";

    ops.forEach(num=>{
      const btn=document.createElement("button");
      btn.innerText=num;
      btn.className="answer-btn";
      btn.onclick=()=>check(num);
      optionsDiv.appendChild(btn);
    });
  }

  function check(val){
    if(answered) return;
    answered=true;

    document.querySelectorAll(".answer-btn").forEach(b=>b.disabled=true);

    if(val===correct){
      score++;
      streak++;
      let msg=["Good job!","Great!","Super!","Nice!"][Math.floor(Math.random()*4)];
      document.getElementById("result").innerHTML=msg;
      sound(800,0.3);

      if(streak===5) { document.getElementById("result").innerHTML="5 in a row! ‚≠ê"; confettiBurst("‚≠ê"); }
      if(streak===10){ document.getElementById("result").innerHTML="10 in a row! üåü"; confettiBurst("üåü"); }
    }
    else {
      streak=0;
      document.getElementById("result").innerHTML="Try again next time!";
      sound(200,0.3);
    }

    setTimeout(nextQ,1200);
  }

  function sendToGoogle(){
    const formURL="https://docs.google.com/forms/d/e/1FAIpQLSfd0N5AF5ifJ6nt3r3PypAGzB8W35Vq2aaEl2liRuvotIiIug/formResponse";
    const data =
      `entry.645887948=${encodeURIComponent(name)}&entry.792395446=${encodeURIComponent(score)}`;

    fetch(formURL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:data
    });
  }

  async function fetchCentralLeaderboard(){
    const csvURL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5g7-A90Fi5k_e8q_nEvUc-wuBdcVH7lu0MDEfWF9YCFajt8i-OEGJSgvE3sVkKQlQ13qHw0M_m2vc/pub?output=csv";

    try {
      const res = await fetch(csvURL);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true });
      const rows = parsed.data
        .filter(r => r.Name && r.Score)
        .sort((a,b)=>parseInt(b.Score)-parseInt(a.Score));

      let html="";
      rows.slice(0,10).forEach((r,i)=>{
        html+=`<div class="leader">${i+1}. ${r.Name} ‚Äî ${r.Score}</div>`;
      });

      document.getElementById("leaderboard").innerHTML=html;
    }
    catch(e){
      document.getElementById("leaderboard").innerHTML="Leaderboard unavailable";
    }
  }

  function endGame(){
    document.getElementById("gameScreen").style.display="none";
    document.getElementById("endScreen").style.display="block";

    if(score===15){
      document.getElementById("endCelebration").innerHTML="üéâ Perfect Exercise!";
      confettiBurst("üéâ");
    } else {
      document.getElementById("endCelebration").innerHTML="Congratulations!";
    }

    document.getElementById("finalScore").innerHTML =
      `Hey ${name}, you scored ${score}/15. Way to go!`;

    sendToGoogle();
    setTimeout(fetchCentralLeaderboard,1000);
  }

  function shareResult(){
    const node=document.getElementById("endScreen");
    html2canvas(node).then(canvas=>{
      canvas.toBlob(blob=>{
        const file=new File([blob],"homework.png",{type:"image/png"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
          navigator.share({files:[file]});
        }
      });
    });
  }
</script>

</body>
</html>
