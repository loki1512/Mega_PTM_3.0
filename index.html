<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add & Pop! Homework</title>

  <!-- Screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    body {
      font-family: "Comic Sans MS", cursive;
      background: linear-gradient(135deg, #fdeff9, #ecf0ff);
      text-align: center;
      padding: 12px;
      color: #333;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 { font-size: 34px; margin-bottom: 6px; }

    .card {
      background: white;
      border-radius: 18px;
      padding: 16px;
      margin: 12px auto;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      max-width: 380px;
    }

    .fruits {
      font-size: 48px;
      display: inline-block;
      animation: drop 0.5s ease-out;
    }

    @keyframes drop {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .correct-anim { animation: bounce 0.6s ease; }
    @keyframes bounce {
      0% { transform: scale(1); }
      30% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .wrong-anim { animation: shake 0.4s ease; }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-6px); }
      100% { transform: translateX(0); }
    }

    button {
      font-size: 24px;
      padding: 12px 20px;
      margin: 6px;
      border-radius: 14px;
      border: none;
      color: white;
    }

    .whatsapp-btn { background: #25D366; font-size: 26px; }
    .replay-btn { background: #ffb300; }
    .submit-btn { background: #007bff; }

    button:disabled { background: #ccc; }

    input {
      font-size: 22px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ddd;
      text-align: center;
      width: 85%;
    }

    #result {
      font-size: 32px;
      margin-top: 6px;
      min-height: 40px;
    }

    .progress { font-size: 20px; margin-bottom: 10px; color: #555; }

    .leader { font-size: 22px; margin: 6px; }

    .confetti {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      animation: confetti-fall 1s ease-out forwards;
      font-size: 38px;
    }

    @keyframes confetti-fall {
      from { transform: translateY(-120px); opacity: 1; }
      to { transform: translateY(300px); opacity: 0; }
    }

    .teacher {
      font-size: 60px;
      margin-bottom: 6px;
      animation: bounce 1.5s infinite alternate;
    }

    footer {
      margin-top: auto;
      padding: 8px;
      font-size: 16px;
      color: #666;
      opacity: 0.95;
    }
  </style>
</head>

<body>

<h1>üçé Add & Pop üçå</h1>

<!-- NAME SCREEN -->
<div id="nameScreen" class="card">
  <p>Type your name</p>
  <input id="nameInput" />
  <br><br>
  <button onclick="startGame()" class="submit-btn">Start</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="card" style="display:none;">
  <div class="progress"><span id="qno"></span> / 15</div>
  <div id="question"></div>
  <div id="options"></div>
  <div id="result"></div>
</div>

<!-- END SCREEN -->
<div id="endScreen" class="card" style="display:none;">
  <div class="teacher">üë©‚Äçüè´</div>
  <h2 id="endCelebration">üéâ Perfect Exercise!</h2>
  <p id="finalScore"></p>

  <h3>üèÜ Leaderboard</h3>
  <div id="leaderboard">Loading...</div>

  <br>
  <button onclick="shareResult()" class="whatsapp-btn">üü¢ WhatsApp</button>
  <button onclick="location.reload()" class="replay-btn">üîÑ Replay</button>
</div>

<footer>An MPPS Pedduru Initiative</footer>

<script>
  let name = "";
  let score = 0;
  let streak = 0;
  let questionCount = 0;
  let correct;
  const TOTAL = 15;
  let answered = false;
  const fruits = ["üçé","üçå","üçá","üçì"];

  const ctx = new (window.AudioContext||window.webkitAudioContext)();

  function sound(f,d){
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.frequency.value=f;
    o.connect(g); 
    g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);
    o.stop(ctx.currentTime+d);
  }

  function confettiBurst(symbol){
    const c=document.createElement("div");
    c.className="confetti";
    c.textContent=symbol;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),900);
  }

  function startGame(){
    name=document.getElementById("nameInput").value||"Friend";
    document.getElementById("nameScreen").style.display="none";
    document.getElementById("gameScreen").style.display="block";
    sound(600,0.2);
    nextQ();
  }

  function nextQ(){
    answered=false;
    if(questionCount===TOTAL){ endGame(); return; }

    questionCount++;
    document.getElementById("qno").innerHTML=questionCount;
    document.getElementById("result").innerHTML="";

    const a=Math.floor(Math.random()*5)+1;
    const b=Math.floor(Math.random()*5)+1;
    correct=a+b;

    const f1=fruits[Math.floor(Math.random()*fruits.length)];
    const f2=fruits[Math.floor(Math.random()*fruits.length)];

    document.getElementById("question").innerHTML=
      `<div class="fruits">${f1.repeat(a)}</div><br>
       <div style="font-size:36px;">+</div><br>
       <div class="fruits">${f2.repeat(b)}</div>`;

    const ops=[correct,correct+1,correct-1].filter(n=>n>0).sort(()=>Math.random()-0.5);

    const optDiv=document.getElementById("options");
    optDiv.innerHTML="";

    ops.forEach(v=>{
      const btn=document.createElement("button");
      btn.innerText=v;
      btn.onclick=()=>check(v);
      optDiv.appendChild(btn);
    });
  }

  function check(v){
    if(answered) return;
    answered=true;

    document.querySelectorAll("#options button").forEach(b=>b.disabled=true);

    if(v===correct){
      score++;
      streak++;
      let phrases=["Good job!","Great!","Nice!","Super!"];
      let msg=phrases[Math.floor(Math.random()*phrases.length)];
      document.getElementById("result").innerHTML=msg;

      document.getElementById("question").classList.add("correct-anim");
      sound(800,0.3);

      if(streak===5){ confettiBurst("‚≠ê"); document.getElementById("result").innerHTML="5 in a row! ‚≠ê"; }
      if(streak===10){ confettiBurst("üåü"); document.getElementById("result").innerHTML="10 in a row! üåü"; }
    }
    else {
      streak=0;
      document.getElementById("result").innerHTML="Try again next time!";
      document.getElementById("question").classList.add("wrong-anim");
      sound(200,0.3);
    }

    setTimeout(()=>{
      document.getElementById("question").classList.remove("correct-anim","wrong-anim");
      nextQ();
    },1200);
  }

  function sendToGoogle(){
    const formURL="https://docs.google.com/forms/d/e/1FAIpQLSe5T6E5S06KfcE0ebGutxyLGAYqzGMVS4lq8cZsUUS9JXtL7g/formResponse";
    const data=`entry.614166214=${encodeURIComponent(name)}&entry.1440673296=${encodeURIComponent(score)}`;

    fetch(formURL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:data
    });
  }

  async function fetchCentralLeaderboard(){
    const csvUrl="https://docs.google.com/spreadsheets/d/2PACX-1vSSl1CFOjQQvN_Q1gHbXw4RSbyt81wOZpxTRvKjyGSumhSPwCCXmorBg8Q_6-HBHKrFAyKpMPH99N1_/gviz/tq?tqx=out:csv";

    try {
      const response = await fetch(csvUrl);
      const csvText = await response.text();

      const parsed = Papa.parse(csvText, { header: true });
      const data = parsed.data;

      const rows = data
        .filter(r => r.Name && r.Score)
        .sort((a,b)=>parseInt(b.Score)-parseInt(a.Score));

      let html="";
      rows.slice(0,10).forEach((r,i)=>{
        html+=`<div class="leader">${i+1}. ${r.Name} ‚Äî ${r.Score}</div>`;
      });

      document.getElementById("leaderboard").innerHTML=html;

    } catch(e){
      document.getElementById("leaderboard").innerHTML="Leaderboard unavailable";
    }
  }

  function endGame(){
    document.getElementById("gameScreen").style.display="none";
    document.getElementById("endScreen").style.display="block";

    if(score===15){
      confettiBurst("üéâ");
      document.getElementById("endCelebration").innerHTML="Perfect Exercise! üéâ";
    } else {
      document.getElementById("endCelebration").innerHTML="Congratulations!";
    }

    document.getElementById("finalScore").innerHTML=`Hey ${name}, you scored ${score}/15. Way to go!`;

    sendToGoogle();
    setTimeout(fetchCentralLeaderboard, 1000);
  }

  function shareResult(){
    const t=document.getElementById("endScreen");
    html2canvas(t).then(c=>{
      c.toBlob(b=>{
        const f=new File([b],"homework.png",{type:"image/png"});
        if(navigator.canShare&&navigator.canShare({files:[f]})){
          navigator.share({files:[f]});
        }
      });
    });
  }
</script>

</body>
</html>
